---
title: Azure Stack Hub 上でデータ センターを拡張する方法
description: Azure Stack Hub でデータ センターを拡張する方法について説明します。
author: mattbriggs
ms.topic: how-to
ms.date: 12/2/2020
ms.author: mabrigg
ms.reviewer: sijuman
ms.lastreviewed: 12/2/2020
ms.openlocfilehash: 02765dbc33fe1bbcb4100e1523be96526549f367
ms.sourcegitcommit: 649540e30e1018b409f4b1142bf2cb392c9e8b0d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/14/2021
ms.locfileid: "98208099"
---
# <a name="extending-storage-to-azure-stack-hub"></a>ストレージを Azure Stack Hub に拡張する

この記事では、Azure Stack Hub を既存のネットワーク環境に統合する方法を決めるのに役立つ Azure Stack Hub ストレージ インフラストラクチャの情報を提供します。 データ センターの拡張について概要を説明した後、2 つの異なるシナリオを紹介します。 Windows ファイル ストレージ サーバーに接続できます。 Windows iSCSI サーバーに接続することもできます。

## <a name="overview-of-extending-storage-to-azure-stack-hub"></a>Azure Stack Hub へのストレージの拡張の概要

データをパブリック クラウドに格納しても十分ではないシナリオがあります。 たとえば、遅延に敏感な、コンピューティング集中型の仮想化されたデータベース ワークロードがあり、パブリック クラウドへのラウンド トリップ時間がデータベース ワークロードのパフォーマンスに影響を与える場合があります。 たとえば、ファイル サーバー、NAS、または iSCSI のストレージ アレイに保持されているオンプレミスのデータがあるとします。それには、オンプレミスのワークロードがアクセスする必要があり、また、規制やコンプライアンスの目標を達成するために、それはオンプレミスに配置されている必要があります。 これらは、データをオンプレミスに常駐させることが、多くの組織にとって重要であることに変わりはないという 2 つのシナリオに過ぎません。

では、なぜ Azure Stack Hub 上のストレージ アカウントで、または Azure Stack Hub システムで実行されている仮想化されたファイル サーバー内でそのデータをホストしないのでしょうか。 Azure とは異なり、Azure Stack Hub のストレージは有限です。 使用量として使用可能な容量は、所有するノードの数に加え、購入することを選択したノードごとの容量によってすべて決まります。 また Azure Stack Hub はハイパーコンバージド ソリューションであるため、使用量のニーズに合わせてストレージ容量を拡大することが必要になった場合は、ノードの追加によってコンピューティングの占有領域を増加することも必要になります。 このコストは、特に追加容量のニーズが、Azure Stack Hub システムの外では低料金で追加できるコールド アーカイブ ストレージの場合、莫大なものになる可能性があります。

このようなことから以下のシナリオをご検討ください。 どうすれば、Azure Stack Hub のシステム (Azure Stack Hub 上で実行されている仮想化されたワークロード) を、ネットワーク経由でアクセス可能な Azure Stack Hub 外部のストレージ システムに、簡単かつ効率的に接続できるでしょうか。

### <a name="design-for-extending-storage"></a>ストレージを拡張するための設計

この図は、ワークロードを実行している単一の仮想マシンを、データの読み取り/書き込みなどの目的で、外部 (VM や Azure Stack Hub 自体の) ストレージに接続して利用するシナリオを示しています。この記事では、ファイルの簡単な取得に焦点を当てますが、データベース ファイルのリモート ストレージなど、より複雑なシナリオに合わせてこの例を拡張することもできます。

![Azure Stack Hub システム上のワークロード VM が外部ストレージにアクセスする。 VM には 2 つの NIC があり、それぞれにパブリック IP アドレスとプライベート IP アドレスの両方がある。](./media/azure-stack-network-howto-extend-datacenter/azure-stack-network-howto-extend-datacenter-image1.svg)

この図では、Azure Stack Hub システム上の VM が複数の NIC を使用してデプロイされていることがわかります。 冗長性だけでなく、ストレージのベスト プラクティスからも、ターゲットと宛先の間に複数のパスを用意することが重要です。 状況が複雑になるのは、Azure と同様に、Azure Stack Hub の VM にパブリック IP とプライベート IP の両方がある場合です。 外部ストレージから VM に到達する必要がある場合は、パブリック IP を使用する必要があります。これは、プライベート IP は主に Azure Stack Hub システム内、vNet およびサブネット内で使用されるためです。 外部ストレージは、サイト間 VPN を経由して vNet 自体に接続しない限り、VM のプライベート IP 空間と通信できません。 したがって、この例では、パブリック IP 空間を介した通信に注目します。 この図のパブリック IP 空間で注目する点は、2 つの異なるパブリック IP プール サブネットがあることです。 既定で、パブリック IP アドレスの目的では Azure Stack Hub には 1 つのプールのみが必要ですが、冗長ルーティングのためには、2 つ目のプールを追加することも考えられます。 ただし、現時点では、1 つの特定のプールから IP アドレスを選択することはできないため、実際には、複数の仮想ネットワーク カードにまたがる同じプールのパブリック IP を持つ VM を使用することになる可能性があります。

この説明では、境界デバイスと外部ストレージ間のルーティングが処理され、トラフィックがネットワークを適切に通過できることを前提とします。 この例では、バックボーンが 1 GbE、10 GbE、25 GbE、またはそれより高速かどうかは関係ありませんが、統合を計画する際は、この外部ストレージにアクセスするアプリケーションのパフォーマンス ニーズに対応することを考慮することが重要です。

## <a name="connect-to-a-windows-server-iscsi-target"></a>Windows Server iSCSI ターゲットに接続する

このシナリオでは、Azure Stack Hub 上で Windows Server 2019 の仮想マシンをデプロイして構成し、外部の iSCSI ターゲット (ここでも Windows Server 2019 が実行されます) に接続するように準備します。 必要に応じて、MPIO などの主要な機能を有効にして、VM と外部ストレージ間のパフォーマンスと接続を最適化します。

### <a name="deploy-the-windows-server-2019-vm-on-azure-stack-hub"></a>Windows Server 2019 VM を Azure Stack Hub にデプロイする

1.  **Azure Stack Hub 管理ポータル** から、このシステムが正しく登録され、マーケットプレースに接続されていると仮定して、 **[Marketplace Management]\(マーケットプレースの管理\)** を選択します。次に、Windows Server 2019 イメージをまだ持っていないと仮定して、 **[Add from Azure]\(Azure から追加\)** を選択し、**Windows Server 2019** を検索し、**Windows Server 2019 Datacenter** イメージを追加します。

    ![[Dashboard > Marketplace management - Marketplace items > Add from Azure]\(ダッシュボード > マーケットプレースの管理 - Marketplace の項目 > Azure から追加\) ダイアログ ボックスで、検索ボックス内に "windows server 2019" が示され、その文字列を含む項目の一覧が表示されている。](./media/azure-stack-network-howto-extend-datacenter/image2.png)

    Windows Server 2019 イメージのダウンロードには時間がかかる場合があります。

2.  Azure Stack Hub 環境に Windows Server 2019 イメージを用意できたら、**Azure Stack Hub ユーザー ポータルにサインインします**。

3.  Azure Stack Hub ユーザー ポータルにログインしたら、[オファーのサブスクリプション](../operator/azure-stack-subscribe-plan-provision-vm.md)があることを確認します。これを使用して、IaaS リソース (コンピューティング、ストレージ、ネットワーク) をプロビジョニングできます。

4.  サブスクリプションを用意できたら、Azure Stack Hub ユーザー ポータルの **ダッシュボード** に戻り、 **[リソースの作成]** を選択し、 **[コンピューティング]** を選択してから、**Windows Server 2019 Datacenter ギャラリー項目** を選択します。

5.  **[基本]** ブレードで、次のように情報を入力します。

    a.  **Name**:VM001

    b.  **ユーザー名**: localadmin

    c.  **[パスワード]** と **[パスワードの確認入力]** : \<password of your choice>

    d.  **[サブスクリプション]** : \<subscription of your choice, with compute/storage/network resources>。

    e.  **リソース グループ**: storagetesting (新規作成)

    f.  **[OK]** を選択します。

6.  **[サイズの選択]** ブレードで **[Standard_F8s_v2]** を選択し、 **[選択]** を選択します。

7.  **[設定]** ブレードで **[仮想ネットワーク]** を選択し、 **[仮想ネットワークの作成]** ブレードでアドレス空間を **10.10.10.0/23** に調整し、[サブネット アドレス範囲] を **10.10.10.0/24** に更新し、 **[OK]** を選択します。

8.  **[パブリック IP アドレス]** を選択し、 **[パブリック IP アドレスの作成]** ブレードで **[静的]** ラジオ ボタンを選択します。

9.  **[パブリック受信ポートを選択]** ドロップダウンで、 **[RDP (3389)]** を選択します。

10. 他の既定値をそのまま使用し、 **[OK]** を選択します。

    ![[ダッシュボード > 新規 > 仮想マシンの作成 > 概要] ダイアログ ボックスに "検証に成功しました" と示され、VM001 に関する情報が表示されている。](./media/azure-stack-network-howto-extend-datacenter/image3.png)

11. 概要を読み、検証を待ってから **[OK]** を選択し、デプロイを開始します。 デプロイは約 10 分で完了します。

12. デプロイが完了したら、 **[リソース]** で仮想マシン名 **[VM001]** を選択し、 **[概要]** を開きます。

    ![[概要] 画面に VM001 に関する情報が表示されている。](./media/azure-stack-network-howto-extend-datacenter/image4.png)

13. [DNS 名] の下で **[構成]** を選択し、DNS 名前ラベル「**vm001**」を指定し、 **[保存]** を選択して、 **[VM001]** を選択します。

14. [概要] ブレードの右側にある仮想ネットワーク/サブネットのテキストで **storagetesting-vnet/default** を選択します。

15. storagetesting-vnet ブレード内で **[サブネット]** 、 **[+サブネット]** の順に選択し、新しい [サブネットの追加] ブレードで次の情報を入力し、 **[OK]** を選択します。

    a.  **名前**: subnet2

    b.  **アドレス範囲 (CIDR ブロック)** :10.10.11.0/24

    c.  **ネットワーク セキュリティ グループ**:なし

    d.  **[ルート テーブル]** :なし

16. 保存したら、 **[VM001]** を選択します。

17. [概要] ブレードの左側から、 **[ネットワーク]** を選択します。

18. **[ネットワーク インターフェイスの接続]** を選択し、 **[ネットワーク インターフェイスの作成]** を選択します。

19. **[ネットワーク インターフェイスの作成]** ブレードで、次の情報を入力します。

    a.  **名前**: vm001nic2

    b.  **サブネット**:サブネットが 10.10.11.0/24 であることを確認します

    c.  **[ネットワーク セキュリティ グループ]** : VM001-nsg

    d. **リソース グループ**: storagetesting

20. 正常に接続されたら、 **[VM001]** を選択し、 **[停止]** を選択して VM をシャットダウンします。

21. VM が停止 (割り当て解除) されたら、[概要] ブレードの左側で **[ネットワーク]** を選択し、 **[ネットワーク インターフェイスの接続]** を選択し、 **[vm001nic2]** を選択して **[OK]** を選択します。 しばらくすると、追加の NIC が VM に追加されます。

22. 引き続き **[ネットワーク]** ブレードで、 **[vm001nic2]** タブを選択し、 **[ネットワーク インターフェイス: vm001nic2]** を選択します。

23. vm001nic インターフェイス ブレードで **[IP 構成]** を選択し、ブレードの中央にある **[ipconfig1]** を選択します。

24. ipconfig1 の設定ブレードで、[パブリック IP アドレス] に **[有効]** を選択し、 **[必要な設定の構成]** 、 **[新規作成]** の順に選択し、名前に「vm001nic2pip」と入力し、 **[静的]** を選択し、 **[OK]** 、 **[保存]** の順に選択します。

25. 正常に保存されたら、VM001 の概要ブレードに戻り、 **[開始]** を選択して、構成された Windows Server 2019 VM を開始します。

26. 開始されたら、VM001 への **RDP セッションを確立** します。

27. VM 内に接続されたら、(管理者として) **CMD** を開き、**hostname** と入力して、OS のコンピューター名を取得します。 **これは VM001 と一致している必要があります**。 後のために、これを書き留めておいてください。

### <a name="configure-second-network-adapter-on-windows-server-2019-vm-on-azure-stack-hub"></a>Azure Stack Hub 上の Windows Server 2019 VM で 2 番目のネットワーク アダプターを構成する

既定では、Azure Stack Hub からは、仮想マシンに接続されている最初の (プライマリ) ネットワーク インターフェイスに既定のゲートウェイが割り当てられます。 仮想マシンに接続されている追加の (セカンダリ) ネットワーク インターフェイスに既定のゲートウェイが Azure Stack Hub から割り当てられることはありません。 したがって、既定では、セカンダリ ネットワーク インターフェイスのサブネット外のリソースと通信することはできません。 ただし、通信を有効にする手順はオペレーティング システムによってそれぞれ異なりますが、セカンダリ ネットワーク インターフェイスはサブネットの外部にあるリソースと通信することができます。

1.  まだ接続を開いていない場合は、**VM001** への RDP 接続を確立してください。

2.  管理者として **CMD** を開き、**route print** を実行します。これにより、この VM 内の 2 つのインターフェイス (Hyper-V ネットワーク アダプター) が返されます。

    !["route print" の出力は次の 2 つのHyper-V ネットワーク アダプターを含むインターフェイスの一覧: インターフェイス 6 は Hyper-V ネットワーク アダプター #2 で、インターフェイス 7 はアダプター #3。](./media/azure-stack-network-howto-extend-datacenter/image5.png)

3.  次に、**ipconfig** を実行して、セカンダリ ネットワーク インターフェイスに割り当てられている IP アドレスを確認します。 この例では、インターフェイス 6 には 10.10.11.4 が割り当てられています。 セカンダリ ネットワーク インターフェイスに対して、既定のゲートウェイ アドレスは返されません。

    ![ipconfig の部分的なリストに Ethernet アダプター Ethernet 2 の IPv4 アドレス 10.10.11.4 が示されている。](./media/azure-stack-network-howto-extend-datacenter/image6.png)

4.  セカンダリ ネットワーク インターフェイスのサブネットの外部にあるアドレスに宛てたすべてのトラフィックを、サブネットのゲートウェイにルーティングするには、**CMD** から次のコマンドを実行します。

    ```CMD  
    route add -p 0.0.0.0 MASK 0.0.0.0 <ipaddress> METRIC 5015 IF <interface>
    ```

    `<ipaddress>` は、現在のサブネットの .1 アドレスで、`<interface>` はインターフェイス番号です。

    ![ipaddress 値 10.10.11.1 とインターフェイス番号 6 を指定した route add コマンドの実行。](./media/azure-stack-network-howto-extend-datacenter/image7.png)

5.  追加されたルートがルート テーブル内にあることを確認するには、**route print** コマンドを入力します。

    ![追加されたルートがゲートウェイ アドレス 10.10.11.1 およびメトリック 5015 の固定ルートとして表示されている。](./media/azure-stack-network-howto-extend-datacenter/image8.png)

6.  次の ping コマンドを実行して送信通信を検証することもできます。  
    `ping 8.8.8.8 -S 10.10.11.4`  
    `-S` フラグを使用すると、ソース アドレスを指定できます。この例では、10.10.11.4 が、現在既定のゲートウェイが設定されている NIC の IP アドレスです。

7.  **CMD** を閉じます。

### <a name="configure-the-windows-server-2019-iscsi-target"></a>Windows Server 2019 iSCSI ターゲットを構成する

このシナリオでは、Windows Server 2019 iSCSI ターゲットが、Azure Stack Hub 環境の外の Hyper-V 上で実行されている仮想マシンである構成を検証します。 この仮想マシンは、8 つの仮想プロセッサ、1 つの VHDX ファイル、そして最も重要な 2 つの仮想ネットワーク アダプターで構成されます。 理想的なシナリオでは、これらのネットワーク アダプターはルーティング可能なサブネットが異なりますが、この検証では、同じサブネット上にネットワーク アダプターがあります。

![ipconfig コマンドの部分的な出力に、同じサブネット上の 2 つの Ethernet アダプターが示されている。IP アドレスは 10.33.131.15 と 10.33.131.16。](./media/azure-stack-network-howto-extend-datacenter/image9.png)

iSCSI ターゲット サーバーの場合、これは、Hyper-V、VMware、または任意の代替アプライアンス (専用の物理 iSCSI SAN など) で実行される Windows Server 2016 または 2019 (物理または仮想) です。 ここで重要な焦点は、Azure Stack Hub システムとの相互接続ですが、ソースと宛先の間に複数のパスを用意することが推奨されます。これは、追加の冗長性を実現し、MPIO など、より高度な機能を使用してパフォーマンスを向上させるためです。

ファイル共有の構成に進む前に、最新の累積的な更新プログラムと修正プログラムで Windows Server 2019 iSCSI ターゲットを更新し、必要に応じて再起動することをお勧めします。

更新して再起動すると、このサーバーを iSCSI ターゲットとして構成できるようになります。

1.  **[サーバー マネージャー]** を開き、 **[管理]** 、 **[役割と機能の追加]** の順に選択します。

2.  開いたら、 **[次へ]** を選択し、 **[役割ベースまたは機能ベースのインストール]** を選択し、 **[サーバーの役割の選択]** ページに到達するまで選択を進めます。

3.  **[ファイル サービスと記憶域サービス]** を展開し、 **[ファイル サービスおよび iSCSI サービス]** を展開して **[iSCSI ターゲット サーバー]** ボックスをオンにし、新しい機能を追加するポップアップ プロンプトを受け入れ、完了まで進みます。

    ![役割と機能の追加ウィザードの [インストール オプションの確認] というタイトルの付いた確認ページ。 [ファイル サービスと記憶域サービス] が展開され、[ファイル サービスおよび iSCSI サービス] が展開されて [iSCSI ターゲット サーバー] が表示されている。](./media/azure-stack-network-howto-extend-datacenter/image10.png)

    完了したら、**サーバー マネージャー** を閉じます。

4.  **エクスプローラー** を開いて C:\\ に移動し、**iSCSI** という **新しいフォルダーを作成** します。

5.  **サーバー マネージャー** をもう一度開き、左側のメニューから **[ファイル サービスと記憶域サービス]** を選択します。

6.  **[iSCSI]** を選択し、右側のペインにある **[iSCSI 仮想ディスクを作成するには、新しい iSCSI 仮想ディスク ウィザードを開始してください]** リンクを選択します。 それを選択します。 ウィザードがポップアップ表示されます。

7.  **[iSCSI 仮想ディスクの場所を選択]** ページで **[カスタム パスを入力してください]** のラジオ ボタンを選択し、**C:\\iSCSI** を参照して、 **[次へ]** を選択します。

8.  iSCSI 仮想ディスクに「**iSCSIdisk1**」という名前を付け、必要に応じて説明を入力し、 **[次へ]** を選択します。

9.  仮想ディスクのサイズを **10GB** に設定し、 **[固定サイズ]** を選択して、 **[次へ]** を選択します。

    ![新しい iSCSI 仮想ディスク ウィザードの [iSCSI 仮想ディスクのサイズ] ページに 10GB の固定サイズが指定され、[割り当てで仮想ディスクを消去する] オプションがオンになっている。](./media/azure-stack-network-howto-extend-datacenter/image11.png)

10) これは新しいターゲットであるため、 **[New iSCSI target]\(新しい iSCSI ターゲット\)** を選択し、 **[次へ]** を選択します。

11) **[ターゲット名の指定]** ページで「**TARGET1**」と入力し、 **[次へ]** を選択します。

12) **[アクセス サーバーの指定]** ページで **[追加]** を選択します。 これにより、iSCSI ターゲットへの接続が承認される特定の **イニシエーター** を入力するためのダイアログが開きます。

13) **[イニシエーター ID の追加]** ウィンドウで、 **[選択した種類の値の入力]** を選択し、 **[種類]** で、IQN がドロップダウン メニューで選択されていることを確認します。 「**iqn.1991-05.com.microsoft:\<computername>** 」と入力し (\<computername> は、**VM001** の **コンピューター名**)、 **[次へ]** を選択します。

    ![[イニシエーター ID の追加] ウィンドウにイニシエーター ID を指定する値が示されている。](./media/azure-stack-network-howto-extend-datacenter/image12.png)

14) **[認証を有効にする]** ページで、ボックスを空白のままにして、 **[次へ]** を選択します。

15) 選択内容を確認して **[作成]** を選択してから、閉じます。 サーバー マネージャーで作成した iSCSI 仮想ディスクが表示されます。

    ![新しい iSCSI 仮想ディスク ウィザードの [結果] ページに ISCSI 仮想ディスクが正常に作成されたことが示されている。](./media/azure-stack-network-howto-extend-datacenter/image13.png)

### <a name="configure-the-windows-server-2019-iscsi-initiator-and-mpio"></a>Windows Server 2019 iSCSI イニシエーターと MPIO を構成する

iSCSI イニシエーターを設定するには、まず、**Azure Stack Hub** システムの **Azure Stack Hub ユーザー ポータル** に再びログインし、**VM001** の **[概要]** ブレードに移動します。

1.  VM001 への RDP 接続を確立します。 接続したら、**サーバー マネージャー** を開きます。

2.  **[役割と機能の追加]** を選択し、 **[機能]** ページが表示されるまで、既定値を受け入れます。

3.  **[機能]** ページで **[マルチパス I/O]** を追加し、 **[次へ]** を選択します。

    ![役割と機能の追加ウィザードの [機能] ページで [マルチパス I/O] という 1 つの機能が選択されている。](./media/azure-stack-network-howto-extend-datacenter/image14.png)

4.  **[必要に応じてターゲット サーバーを自動的に再起動する]** ボックスをオンにして **[インストール]** を選択し、 **[閉じる]** を選択します。 再起動が必要になる可能性が高いため、完了したら VM001 に再接続します。

5.  **サーバー マネージャー** に戻り、**MPIO のインストールが完了する** のを待って **[閉じる]** を選択してから、 **[ツール]** を選択し、 **[MPIO]** を選択します。

6.  **[マルチパスの検出]** タブを選択し **[iSCSI デバイスのサポートを追加する]** ボックスをオンにし、 **[追加]** を選択し、 **[はい]** を選択して VM001 を **再起動** します。 ウィンドウが表示されない場合は、 **[OK]** を選択し、手動で再起動します。

    ![MPIO ダイアログ ボックスの [マルチパスの検出] ページで [iSCSI デバイスのサポートを追加する] オプションがオンになっているのが示されている。 [追加] ボタンがある。](./media/azure-stack-network-howto-extend-datacenter/image15.png)

7.  再起動したら、**VM001 への新しい RDP 接続** を確立します。

8.  接続したら、**サーバー マネージャー** を開き、 **[ツール]** を選択し、 **[iSCSI イニシエーター]** を選択します。

9.  Microsoft iSCSI ウィンドウが表示されたら、 **[はい]** を選択して、既定で iSCSI サービスを実行できるようにします。

    ![[Microsoft iSCSI] ダイアログ ボックスに iSCSI サービスが実行されていないことが報告されている。サービスを開始するための [はい] ボタンがある。](./media/azure-stack-network-howto-extend-datacenter/image16.png)

10. [iSCSI イニシエーターのプロパティ] ウィンドウで、 **[探索]** タブを選択します。

11. ここで 2 つのターゲットを追加します。そのため、最初に **[ポータルの探索]** ボタンを選択します。

12. iSCSI ターゲット サーバーの最初の IP アドレスを入力し、 **[詳細]** を選択します。

    ![[ターゲット ポータルの探索] ウィンドウの [IP アドレスまたは DNS 名:] テキスト ボックスに "10.33.131.15"、[ポート] テキスト ボックスに "3260" (既定値) が示されている。 [詳細] ボタンがある。](./media/azure-stack-network-howto-extend-datacenter/image17.png)

13. **[詳細設定]** ウィンドウで、次のものを選択し、 **[OK]** を選択します。

    a.  **ローカル アダプター**: Microsoft iSCSI イニシエーター。

    b.  **イニシエーター IP**: 10.10.10.4。

14. **[ターゲット ポータルの探索]** ウィンドウに戻り、 **[OK]** を選択します。

15. 以下で、プロセスを繰り返します。

    a. **IP アドレス**: 2 番目の iSCSI ターゲットの IP アドレス。

    b.  **ローカル アダプター**: Microsoft iSCSI イニシエーター。

    c.  **イニシエーター IP**: 10.10.11.4。

16. ターゲット ポータルは次のようになります。 **[アドレス]** 列には、独自の iSCSI ターゲット IP が指定されています。

    ![[ターゲット ポータル] ダイアログ ボックスに作成されたばかりの 2 つのポータルが示されている。 IP アドレスは 10.33.131.15 と 10.33.131.16。](./media/azure-stack-network-howto-extend-datacenter/image18.png)

17. **[ターゲット]** タブに戻り、ウィンドウの中央から iSCSI ターゲットを選択し、 **[接続]** を選択します。

18. **[ターゲットへの接続]** ウィンドウで、 **[複数パスを有効にする]** チェック ボックスをオンにし、 **[詳細]** を選択します。

    ![[ターゲットへの接続] ダイアログ ボックスに指定した値が示されている。 [詳細] ボタンと [OK] ボタンがある。](./media/azure-stack-network-howto-extend-datacenter/image19.png)

19. 次の情報を入力して **[OK]** を選択し、 **[ターゲットへの接続]** ウィンドウで **[OK]** を選択します。

    a.  **ローカル アダプター**: Microsoft iSCSI イニシエーター。

    b.  **イニシエーター IP**: 10.10.10.4。

    c.  **ターゲット ポータル IP**: \<your first iSCSI Target IP / 3260>。

    ![[接続方法] ダイアログ ボックスにターゲット ポータル 10.33.131.15/3260 に指定した情報が示されている。](./media/azure-stack-network-howto-extend-datacenter/image20.png)

1.  2 番目のイニシエーターとターゲットの組み合わせに対して、このプロセスを繰り返します。

    a. **ローカル アダプター**: Microsoft iSCSI イニシエーター。

    b.  **イニシエーター IP**: 10.10.11.4。

    c.  **ターゲット ポータル IP**: \<your second iSCSI Target IP / 3260>。

    ![[接続方法] ダイアログ ボックスにターゲット ポータル 10.33.131.16/3260 に指定した情報が示されている。](./media/azure-stack-network-howto-extend-datacenter/image21.png)

2.  **[ボリュームとデバイス]** タブを選択し、 **[自動構成]** を選択します。次のように MPIO ボリュームが提示されます。

    ![[ボリュームの一覧] ウィンドウに 1 つのボリュームのボリューム名、マウント ポイント、デバイスが表示されている。](./media/azure-stack-network-howto-extend-datacenter/image22.png)

3.  **[ターゲット]** タブに戻り、 **[デバイス]** を選択すると、前に作成した 1 つの iSCSI VHD への 2 つの接続が表示されます。

    ![[デバイス] ダイアログ ボックスに Disk 2 が 2 行に表示されている。 最初の行のターゲットは 0、2 行目は 1。](./media/azure-stack-network-howto-extend-datacenter/image23.png)

4.  **[MPIO]** ボタンを選択すると、負荷分散ポリシーとパスの詳細情報が表示されます。

    ![[デバイスの詳細] ダイアログ ボックスの [MPIO] ページの [負荷分散ポリシー] に [ラウンド ロビン] が表示されている。](./media/azure-stack-network-howto-extend-datacenter/image24.png)

5.  **[OK]** を 3 回選択してウィンドウと iSCSI イニシエーターを閉じます。

6.  ディスク管理 (diskmgmt.msc) を開くと、 **[ディスクの初期化]** ウィンドウが表示されます。

    ![[ディスクの初期化] ダイアログ ボックスで [Disk 2] が選択され、パーティション スタイルとして [MBR (マスター ブート レコード)] が選択されている。 [OK] ボタンがある。](./media/azure-stack-network-howto-extend-datacenter/image25.png)

7.  **[OK]** を選択して既定値を受け入れ、新しいディスクまでスクロールダウンし、右クリックして、 **[新しいシンプル ボリューム]** を選択します。

8.  ウィザードの指示に従って、既定値を受け入れます。 ボリューム ラベルを「**iSCSIdisk1**」に変更し、 **[完了]** を選択します。

    ![[新しいシンプル ボリューム ウィザード] ダイアログ ボックスに、ボリュームが既定のアロケーション ユニット サイズでボリューム ラベルが "iSCSIdisk1" である NTFS となることが示されている。 クイック フォーマットが選択されている。 [次へ] ボタンがある。](./media/azure-stack-network-howto-extend-datacenter/image26.png)

9.  これにより、ドライブがフォーマットされ、ドライブ文字が表示されます。

10. **エクスプローラー** を開き、 **[PC]**  を選択すると、新しいドライブが VM001 に接続されているのを確認できます。

### <a name="testing-external-storage-connectivity"></a>外部ストレージ接続をテストする

通信を確認して、基本的なファイル コピー テストを実行するには、まず、**Azure Stack Hub** システムの **Azure Stack Hub ユーザー ポータル** に再びログインし、**VM001** の **[概要]** ブレードに移動します。

1.  **[接続]** を選択して **VM001** への RDP 接続を確立します。

2.  **タスク マネージャー** を開き、 **[パフォーマンス]** タブを選択し、ウィンドウを RDP セッションの右側にスナップします。

3.  管理者として **Windows PowerShell ISE** を開き、RDP セッションの左側にスナップします。 ISE の右側で、 **[コマンド]** ペインを閉じ、 **[スクリプト]** ボタンを選択して、ISE ウィンドウの上部にある白いスクリプト ペインを展開します。

4.  この VM には、iSCSI ターゲットへのファイル転送をテストするための大きなファイルとして使用する VHD を作成するためのネイティブ PowerShell モジュールがありません。 この場合は、DiskPart を実行して VHD ファイルを作成します。 ISE で、次を実行します。

    1. `Start-Process Diskpart`

    2. 新しい CMD ウィンドウが開きます。次のように入力してください。  
        `**Create vdisk file="c:\\test.vhd" type=fixed maximum=5120**`
    
    ![CMD ウィンドウに、指定したコマンドが DiskPart に対して発行され、そこで正常に実行され、仮想ディスク ファイルが作成されたことが示されている。](./media/azure-stack-network-howto-extend-datacenter/image27.png)
    
    3.  作成にはしばらく時間がかかります。 作成されたら、作成を検証するために、**エクスプローラー** を開き、C:\\ に移動します。新しい test.vhd があり、サイズが 5 GB であることを確認できます。

    ![ファイル test.vhd が予期した通りに C:\, 内に表示され、指定したサイズである。](./media/azure-stack-network-howto-extend-datacenter/image28.png)

    4. CMD ウィンドウを閉じて ISE に戻り、スクリプト ウィンドウに次のコマンドを入力します。 F:\\ は、前に適用した iSCSI ターゲット ドライブ文字に置き換えます。

    5. `Copy-Item "C:\\test.vhd" -Destination "F:\\"`

    6. スクリプト ウィンドウで行を選択し、F8 を押してを実行します。

    7. コマンドが実行されている間、2 つのネットワーク アダプターを監視し、VM001 の両方のネットワーク アダプター間でデータの転送が行われていることを確認します。 また、各ネットワーク アダプターで負荷が均等に共有されていることにも注意してください。

    ![両方のアダプターの負荷が 2.6 Mbps であることが示されている。](./media/azure-stack-network-howto-extend-datacenter/image29.png)

このシナリオは、Azure Stack Hub で実行されているワークロードと外部ストレージ アレイ (この場合、Windows Server ベースの iSCSI ターゲット) との間の接続に焦点を当てるように設計されました。 これは、パフォーマンス テストとして使用するように設計されたものではなく、また別の iSCSI ベースのアプライアンスを使用している場合に実行する必要がある手順も反映していません。これは、Azure Stack Hub にワークロードをデプロイする際や Azure Stack Hub 環境の外のストレージ システムに接続する際のいくつかの主な考慮事項に焦点を当てています。

## <a name="next-steps"></a>次のステップ

[Azure Stack Hub ネットワークの違いと考慮事項](azure-stack-network-differences.md)
