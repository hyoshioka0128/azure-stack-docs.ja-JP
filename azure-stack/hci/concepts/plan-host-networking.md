---
title: Azure Stack HCI のホスト ネットワークを計画する
description: Azure Stack HCI クラスターのホスト ネットワークを計画する方法について説明します
author: v-dasis
ms.topic: how-to
ms.date: 10/13/2020
ms.author: v-dasis
ms.reviewer: JasonGerend
ms.openlocfilehash: 8f18cd223faca91bc490b659e0a25fce1add3fea
ms.sourcegitcommit: 4b1a4ec0ac0283faea9438e6617fcb3cfc6fee6d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/14/2020
ms.locfileid: "92041226"
---
# <a name="plan-host-networking-for-azure-stack-hci"></a>Azure Stack HCI のホスト ネットワークを計画する

> 適用対象: Azure Stack HCI バージョン 20H2

このトピックでは、非ストレッチおよびストレッチの Azure Stack HCI クラスター環境でのホスト ネットワークの計画に関する考慮事項と要件について説明します。

## <a name="traffic-types-supported"></a>サポートされているトラフィックの種類

Azure Stack HCI によってサーバー メッセージ ブロック (SMB) が使用されています。 Azure Stack HCI の SMB でサポートされているトラフィックの種類は、次のとおりです。

- 記憶域バス レイヤー (SBL) - 記憶域スペース ダイレクトによって使用される、最も優先度が高いトラフィック
- クラスター共有ボリューム (CSV)
- ライブ マイグレーション (LM)
- ストレージ レプリカ (SR) - ストレッチ クラスターで使用
- ファイル共有 (FS) - 従来の FS およびスケールアウト ファイル サーバー (SOFS)
- クラスター ハートビート (HB)
- クラスター通信 (ノードの結合、クラスターの更新、レジストリの更新)

SMB トラフィックは、次のプロトコル経由でフローできます。

- トランスポート制御プロトコル (TCP) - サイト間で使用
- リモート ダイレクト メモリ アクセス (RDMA)
- QUIC - 予定

## <a name="traffic-bandwidth-allocation"></a>トラフィックの帯域幅の割り当て

次の表は、さまざまな種類のトラフィックに対する帯域幅の割り当てを示しています。

- 単位はすべて Gbps です
- 値は、ストレッチと非ストレッチの両方のクラスターに適用されます
- SMB トラフィックが合計帯域幅割り当ての 50% を確保しています
- 記憶域バス レイヤー/クラスターの共有ボリューム (SBL/CSV) トラフィックが、残りの 50% の割り当ての 70% を確保しています
- ライブ マイグレーション (LM) トラフィックにより、残りの 50% の割り当ての 15% が確保されています
- 記憶域レプリカ (SR) トラフィックにより、残りの 50% の割り当ての 14% が確保されています
- ハートビート (HB) トラフィックにより、残りの 50% の割り当ての 1% が確保されています
- \* LM トラフィックに対する帯域幅の割り当てが 5 Gbps 未満の場合は、RDMA ではなく圧縮を使用する必要があります

|NIC 速度|チーム化された NIC 速度|SMB 50% 予約|SBL/CSV %|SBL/CSV 帯域幅|LM %|LM 帯域幅|SR % |SR 帯域幅|HB %|HB 帯域幅|
|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
|10|20|10|70%|7|14%*|1.4*|14%|1.4|2%|0.2|
|25|50|25|70%|17.5|15%*|3.75*|14%|3.5|1%|0.25|
|40|80| 40|70%|28|15%|6|14%|5.6|1%|0.4|
|50|100|50|70%|35|15%|7.5|14%|7|1%|0.5|
|100|200|100|70%|70|15%|15|14%|14|1%|1|
|200|400|200|70%|140|15%|30|14%|28|1%|2|

## <a name="rdma-considerations"></a>RDMA に関する考慮事項

リモート ダイレクト メモリ アクセス (RDMA) とは、あるコンピューターのメモリから別のコンピュータのそれへの直接メモリ アクセスであり、どちらかのコンピュータのオペレーティングシステムを介しません。 これにより、CPU 使用率を最小限に抑えながら、高スループットで低待機時間のネットワークが可能になります。これは、クラスターで特に役立ちます。

すべてのホスト RDMA トラフィックで SMB ダイレクトが利用されています。 SMB ダイレクトは、RDMA を介して送信される SMB 3.0 トラフィックであり、ポート 445 を介して多重化されます。 現在市場に出回っている、および将来の物理スイッチの大部分との互換性を維持するには、RDMA トラフィックに少なくとも 2 つの優先順位ベースのフロー制御 (PFC) 対応のトラフィック クラス (TC) を使用する必要があります。

Internet Wide Area RDMA Protocol (iWARP) が TCP 経由で RDMA を実行するのに対し、RDMA over Converged Ethernet (RoCE) は TCP の使用を回避しますが、それをサポートする NIC と物理スイッチの両方が必要です。 RDMA over RoCE の収束ネットワーク要件については、[Windows Server 2016 および 2019 の RDMA 展開ガイド](https://github.com/Microsoft/SDN/blob/master/Diagnostics/S2D%20WS2016_ConvergedNIC_Configuration.docx)を参照してください。

RDMA は、同じサブネット上のサイト内のクラスター ノード間のすべての East/West トラフィックに対して既定で有効になっています。 RDMA は無効になっており、異なるサブネット上のサイト間の North/South ストレッチ クラスター トラフィックによってサポートされていません。

Azure Stack HCI の RDMA の要件は次のとおりです。

- サブネット間およびサイト間 (ストレッチ クラスター) のトラフィックはすべて、WinSock TCP を使用する必要があります。 すべての中間ネットワーク ホップは、Azure Stack HCI のビューとコントロールの外側にあります。
- サブネット間およびサイト間 (ストレッチ クラスター) の RDMA はサポートされていません。 アップリンクと複数のネットワーク デバイスの使用は、不安定になり、サポートできなくなるおそれがある複数の障害点を意味します。
- ストレッチ クラスターの記憶域レプリカのトラフィックには、追加の仮想 NIC は必要ありません。 ただし、トラブルシューティングの目的で、サイト間とサブネット間のトラフィックを、East-West RDMA トラフィックと分離しておくと便利な場合があります。 SMB ダイレクトによって、フローごとにサイト間またはサブネット間をネイティブに無効にできない場合は、次のようにします。
    - 記憶域レプリカ用に 1 つ以上の追加の vNIC をプロビジョニングする必要があります
    - 記憶域レプリカ vNIC は、定義上、サイト間とサブネット間であるため、PowerShell [Disable-NetAdapterRDMA](https://docs.microsoft.com/powershell/module/netadapter/disable-netadapterrdma) コマンドレットを使用して RDMA を無効にする必要があります
    - ネイティブ RDMA アダプターには、上記のサイトまたはサブネット要件を満たすために、記憶域レプリカをサポートするための vSwitch と vNIC が必要です
    - サイト内 RDMA 帯域幅の要件については、「**トラフィックの帯域幅の割り当て**」セクションで説明したように、トラフィックの種類ごとの帯域幅の割合を把握している必要があります。 これにより、East/West (ノード間) のトラフィックに適切な帯域幅の予約と制限を確実に適用できるようになります
- ライブ マイグレーションと記憶域レプリカのトラフィックは、SMB 帯域幅に制限されている必要があります。そうしないと、すべての帯域幅が消費され、優先順位の高い記憶域トラフィックが不足するおそれがあります。 詳細については、PowerShell コマンドレット「[Set-SmbBandwidthLimit](https://docs.microsoft.com/powershell/module/smbshare/set-smbbandwidthlimit)」と「[Set-SRNetworkConstraint](https://docs.microsoft.com/powershell/module/storagereplica/set-srnetworkconstraint)」を参照してください。

> [!NOTE]
> `Set-SmbBandwidthLimit` コマンドレットを使用する場合は、ビットをバイトに変換する必要があります。

## <a name="node-interconnect-requirements"></a>ノード相互接続の要件

ここでは、"相互接続" と呼ばれる、サイト内のサーバー ノード間の具体的なネットワーク要件について説明します。 スイッチ ノードまたはスイッチレス ノードの相互接続を次のように使用できます。

- **スイッチ:** サーバー ノードは通常、ネットワーク スイッチを使用するイーサネット ネットワーク経由で相互接続されます。 帯域幅とネットワークの種類に対応するようにスイッチを適切に構成する必要があります。 RoCE プロトコルを実装する RDMA を使用する場合は、ネットワーク　デバイスとスイッチの構成が重要になります。
- **スイッチレス:** サーバー ノードは、スイッチを使用せずに直接イーサネット接続を使用して相互接続することもできます。 この場合、各サーバー ノードは、同じサイト内の他のすべてのクラスター ノードと直接接続している必要があります。

### <a name="interconnects-for-2-3-node-clusters"></a>2 または 3 ノードのクラスターの相互接続

以下は、2 つまたは 3 つのノードを持つ単一サイト クラスターについての "*最小*" の相互接続要件です。 これらは、サーバー ノードごとに適用されます。

- 管理機能に使用する 1 つ以上の 1 Gb ネットワーク アダプター カード
- ストレージとワークロードのトラフィック用に 1 つ以上の 10 Gb (またはそれ以上) のネットワーク インターフェイス カード
- 各ノード間に 2 つ以上のネットワーク接続 (冗長性とパフォーマンスのために推奨)

### <a name="interconnects-for-4-node-and-greater-clusters"></a>4 ノード以上のクラスターの相互接続

以下は、4 つ以上のノードを持つクラスターと、高パフォーマンス クラスターについての "*最小*" の相互接続要件です。 これらは、サーバー ノードごとに適用されます。

- 管理機能に使用する 1 つ以上の 1 Gb ネットワーク アダプター カード。
- ストレージとワークロードのトラフィック用に 1 つ以上の 25 Gb (またはそれ以上) のネットワーク インターフェイス カード。 冗長性とパフォーマンスのために 2 つ以上のネットワーク接続が推奨されます。
- リモート ダイレクト メモリ アクセス (RDMA) 対応のネットワーク カード: iWARP (推奨) または RoCE。

### <a name="site-to-site-requirements-stretched-cluster"></a>サイト間の要件 (ストレッチ クラスター)

ストレッチ クラスターでサイト間接続を行う場合、各サイト内の相互接続要件が引き続き適用され、記憶域レプリカと Hyper-V ライブ マイグレーションのトラフィックに関する以下の追加要件を考慮する必要があります。

- 同期レプリケーション用にサイト間で少なくとも 1 つの 1 Gb RDMA またはイーサネット/TCP 接続。 25 Gb の接続をお勧めします。
- サイト間のネットワーク。I/O 書き込みワークロードを格納するのに十分な帯域幅を備え、同期レプリケーションでの平均ラウンド トリップ待機時間が 5ms 以内のもの。 非同期レプリケーションには待機時間に関する推奨事項はありません。
- サイト間で単一の接続を使用する場合は、PowerShell を使用して記憶域レプリカの SMB 帯域幅の制限を設定します。 詳細については、「[Set-SmbBandwidthLimit](/powershell/module/smbshare/set-smbbandwidthlimit)」を参照してください。
- サイト間で複数の接続を使用する場合は、接続間でトラフィックを分離します。 たとえば、記憶域レプリカのトラフィックを、PowerShell を使用した Hyper-V のライブ マイグレーションのトラフィックとは別のネットワークに配置します。 詳細については、「[Set-SRNetworkConstraint](/powershell/module/storagereplica/set-srnetworkconstraint)」を参照してください。

## <a name="network-port-requirements"></a>ネットワーク ポートの要件

サイト内およびサイト間 (ストレッチ クラスターの場合) の両方のすべてのサーバー ノード間で、適切なネットワーク ポートが開いていることを確認します。 ファイアウォールとルーターには、クラスター内のすべてのサーバー間で ICMP、SMB (ポート 445、および SMB ダイレクト用のポート 5445)、WS-MAN (ポート 5985) の双方向トラフィックを許可するための適切な規則が必要になります。

Windows Admin Center で [クラスターの作成] ウィザードを使用してクラスターを作成すると、クラスター内の各サーバーで、フェールオーバー クラスタリング、Hyper-V、記憶域レプリカ用の該当するファイアウォール ポートがウィザードによって自動的に開かれます。 各サーバーで異なるファイアウォールを使用している場合は、次のポートを開きます。

### <a name="failover-clustering-ports"></a>フェールオーバー クラスタリングのポート

- ICMPv4 および ICMPv6
- TCP ポート 445
- RPC 動的ポート
- TCP ポート 135
- TCP ポート 137
- TCP ポート 3343
- UDP ポート 3343

### <a name="hyper-v-ports"></a>Hyper-V ポート

- TCP ポート 135
- TCP ポート 80 (HTTP 接続)
- TCP ポート 443 (HTTPS 接続)
- TCP ポート 6600
- TCP ポート 2179
- RPC 動的ポート
- RPC エンドポイント マッパー
- TCP ポート 445

### <a name="storage-replica-ports-stretched-cluster"></a>ストレージ レプリカ ポート (ストレッチ クラスター)

- TCP ポート 445
- TCP 5445 (iWarp RDMA を使用している場合)
- TCP ポート 5985
- ICMPv4 および ICMPv6 (`Test-SRTopology` PowerShell コマンドレットを使用している場合)

上記の一覧にないポートが追加で必要になる場合があります。 これらは、Azure Stack HCI の基本機能用のポートです。

## <a name="network-switch-requirements"></a>ネットワーク スイッチの要件

このセクションでは、Azure Stack HCI で使用される物理スイッチの要件を定義します。 これらの要件には、すべての Azure Stack HCI のデプロイに必須の業界仕様、組織の標準、およびプロトコルが含まれます。 特に明記されていない限り、標準の最新のアクティブな (置き換えられていない) バージョンが必要です。

これらの要件は、Azure Stack HCI クラスターのデプロイでのノード間に信頼性の高い通信を確保するのに役立ちます。 ノード間の信頼性の高い通信は重要です。 Azure Stack HCI に必要なレベルの信頼性を備えるには、スイッチに次のことが必要です。

- 該当する業界仕様、標準、およびプロトコルに準拠している
- スイッチでどの仕様、標準、プロトコルがサポートされるかに関する可視性を提供する
- どの機能が有効になっているかに関する情報を提供する

お使いのスイッチで以下がサポートされている場合は、スイッチのベンダーにお問い合わせください。

#### <a name="standard-ieee-8021q"></a>標準: IEEE 802.1Q

イーサネット スイッチは、VLAN を定義する IEEE 802.1 Q 仕様に準拠している必要があります。 VLAN は Azure Stack HCI のいくつかの側面に必要であり、すべてのシナリオで必要です。

#### <a name="standard-ieee-8021qbb"></a>標準: IEEE 802.1Qbb

イーサネット スイッチは、プライオリティ フロー制御 (PFC) を定義する IEEE 802.1Qbb 仕様に準拠している必要があります。 PFC は、データ センター ブリッジング (DCB) を使用する場合に必要です。 DCB は RoCE と iWARP RDMA の両方のシナリオで使用できるため、802.1 Qbb はすべてのシナリオで必要です。 スイッチ機能またはポート速度をダウングレードせずに、少なくとも 3 つのサービスのクラス (CoS) の優先順位が必要です。

#### <a name="standard-ieee-8021qaz"></a>標準: IEEE 802.1Qaz

イーサネット スイッチは、拡張送信選択 (ETS) を定義する IEEE 802.1Qaz 仕様に準拠している必要があります。 ETS は、DCB を使用する場合に必要です。 DCB は RoCE と iWARP RDMA の両方のシナリオで使用できるため、802.1Qaz はすべてのシナリオで必要です。 スイッチ機能またはポート速度をダウングレードせずに、少なくとも 3 つの CoS の優先順位が必要です。

#### <a name="standard-ieee-8021ab"></a>標準: IEEE 802.1AB

イーサネット スイッチは、Link Layer Discovery Protocol (LLDP) を定義する IEEE 802.1AB 仕様に準拠している必要があります。 LLDP は、Windows によるスイッチの構成の検出に必要です。 LLDP の Type-Length-Values (TLV) の構成は、動的に有効にする必要があります。 これらのスイッチには、追加の構成は必要ありません。

たとえば、802.1 サブタイプ 3 を有効にすると、スイッチ ポートで使用可能なすべての VLAN が自動的にアドバタイズされます。

#### <a name="tlv-requirements"></a>TLV の要件

LLDP を使用すると、組織は独自のカスタム TLV を定義してエンコードすることができます。 これらは、組織固有の TLV と呼ばれます。 すべての組織固有の TLV は、127 という LLDP TLV Type 値で開始されます。 次の表に、どのような組織固有のカスタム TLV (TLV Type 127) サブタイプが必要であり、どれが省略可能であるかを示します。

|条件|Organization|TLV サブタイプ|
|-|-|-|
|必須|IEEE 802.1|VLAN 名 (サブタイプ = 3)|
|必須|IEEE 802.3|最大フレーム サイズ (サブタイプ = 4)|
|省略可能|IEEE 802.1|ポート VLAN ID (サブタイプ = 1)|
|省略可能|IEEE 802.1|ポートとプロトコル VLAN ID (サブタイプ = 2)|
|省略可能|IEEE 802.1|リンク アグリゲーション (サブタイプ = 7)|
|省略可能|IEEE 802.1|輻輳通知 (サブタイプ = 8)|
|省略可能|IEEE 802.1|ETS 構成 (サブタイプ = 9)|
|省略可能|IEEE 802.1|ETS レコメンデーション (サブタイプ = A)|
|省略可能|IEEE 802.1|PFC 構成 (サブタイプ = B)|
|省略可能|IEEE 802.1|EVB (サブタイプ = D)|
|省略可能|IEEE 802.3|リンク アグリゲーション (サブタイプ = 3)|

> [!NOTE]
> 一覧表示されているオプション機能の一部は、今後必要になる場合があります。

## <a name="next-steps"></a>次のステップ

- フェールオーバー クラスタリングの基礎を復習する。 [フェールオーバー クラスタリング ネットワークの基礎](https://techcommunity.microsoft.com/t5/failover-clustering/failover-clustering-networking-basics-and-fundamentals/ba-p/1706005?s=09)に関するページを参照
- SET の使用を復習する。 「[リモート ダイレクト メモリ アクセス (RDMA) とスイッチ埋め込みチーミング (SET)](https://docs.microsoft.com/windows-server/virtualization/hyper-v-virtual-switch/rdma-and-switch-embedded-teaming)」を参照
- 展開については、[Windows Admin Center を使用したクラスターの作成](https://docs.microsoft.com/azure-stack/hci/deploy/create-cluster)に関する記事を参照
- 展開については、[Windows PowerShell を使用したクラスターの作成](https://docs.microsoft.com/azure-stack/hci/deploy/create-cluster-powershell)に関する記事を参照